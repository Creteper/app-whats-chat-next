# 功能演示说明

本文档展示如何使用新实现的对话历史记录管理和场景信息交互功能。

## 🎯 快速开始

### 1. 设置 AI 供应商

1. 打开应用
2. 进入 `设置` 页面（`/home/settings`）
3. 选择 AI 供应商：
   - **DeepSeek API** (推荐，已完全集成)
   - CyberChat API (TODO)
   - 自定义 API (TODO)

### 2. 开始对话

1. 选择一个 AI 角色
2. 进入聊天页面
3. 发送消息开始对话

---

## 💬 对话示例

### 示例 1：基础对话

**用户输入**:
```
你好，今天天气怎么样？
```

**AI 回复（自动解析）**:
```
┌──────────────────────────┐
│ 你好啊！今天天气很好呢   │
└──────────────────────────┘

┌──────────────────────────┐
│ 阳光明媚，特别适合出去玩 │
└──────────────────────────┘

┌──────────────────────────┐
│ 你要不要和我一起出去？   │
└──────────────────────────┘
  14:30:25
```

💭 今天他主动和我说话了，感觉有点开心...

✨ 将要走到窗边看看外面的风景

[📍场景] [👔服饰] [🏃动作] [🛤️事件] [❤️发情度] [✨心动度]
  ↑ 悬停查看详细信息

---

### 示例 2：场景信息展示

#### 桌面端（悬停查看）

当鼠标悬停在 **📍场景** 按钮上时：

**Tooltip 显示**:
```
公园的长椅上，周围有绿树和花坛
```

当鼠标悬停在 **❤️发情度** 按钮上时：

**Tooltip 显示**:
```
15
```

当鼠标悬停在 **✨心动度** 按钮上时：

**Tooltip 显示**:
```
25
```

#### 移动端（点击查看）

点击 **"查看场景详情"** 按钮后：

**Sheet 抽屉显示**:
```
┌────────────────────────────────┐
│ 场景信息                        │
│ 当前场景的详细状态信息          │
├────────────────────────────────┤
│                                │
│ 📍 场景                         │
│    公园的长椅上，周围有绿树和   │
│    花坛                         │
│                                │
│ 👔 服饰                         │
│    白色连衣裙、粉色内衣、白色   │
│    平底鞋                       │
│                                │
│ 🏃 动作                         │
│    坐在长椅上，双手放在膝盖上   │
│                                │
│ 🛤️ 事件                         │
│    公园→散步→坐下休息→聊天      │
│                                │
│ ❤️ 发情程度                     │
│    15                          │
│                                │
│ ✨ 心动程度                     │
│    25                          │
│                                │
└────────────────────────────────┘
```

---

### 示例 3：记忆管理

#### 第一轮对话

**用户**: "我们约定一下，以后我叫你小美，你叫我主人，可以吗？"

**AI**: 
```
好的，主人~
从现在开始，我就是小美啦！
```

📝 **记忆总结**（点击展开）:
```
称呼：
- 用户称呼AI为：小美
- AI称呼用户为：主人
```

#### 第二轮对话（AI会记住称呼）

**用户**: "小美，今天吃什么？"

**AI**:
```
主人，我们今天吃火锅好不好？
我特别想吃火锅呢~
```

---

### 示例 4：情感追踪

#### 对话序列

**第1轮对话后**:
- 心动度: 5
- 发情度: 0

**第2轮对话后**（用户夸奖AI）:
- 心动度: 15 ↑
- 发情度: 5 ↑

**第3轮对话后**（继续互动）:
- 心动度: 30 ↑↑
- 发情度: 20 ↑↑↑

AI 的回复会根据这些数值变化而调整，表现出更多的情感反应。

---

## 🎨 标签使用指南

### Speech 标签（对话）

**用途**: AI 的正常对话内容

**示例**:
```xml
<speech>你好，很高兴见到你！</speech>
<speech>今天天气真不错。</speech>
<speech>我们出去走走吧？</speech>
```

**特点**:
- 可以使用多个 speech 标签
- 每个 speech 独立显示为一个气泡
- 时间戳只在最后一个 speech 后显示

---

### Inner Thoughts 标签（内心想法）

**用途**: 表达 AI 角色的内心活动

**示例**:
```xml
<inner thoughts>他今天看起来心情不错，我也很开心...</inner thoughts>
```

**渲染效果**:
```
💭 他今天看起来心情不错，我也很开心...
```

---

### Feature 标签（即将行动）

**用途**: 告知用户 AI 接下来要做什么，并自动显示场景信息

**示例**:
```xml
<feature>将要走到窗边看看风景</feature>
```

**渲染效果**:
```
✨ 将要走到窗边看看风景

[📍场景] [👔服饰] [🏃动作] [🛤️事件] [❤️发情度] [✨心动度]
```

---

### Mem 标签（记忆总结）

**用途**: 总结场所、规则、称呼等重要信息

**示例**:
```xml
<mem>
场所：
- 卧室：双人床在门口面前，独立卫生间在右侧

规则：
- 全局：不许在对方面前骂人
- 卧室：9点之后小美洗澡

称呼：
- 用户称呼AI：小美、宝贝
- AI称呼用户：主人
</mem>
```

**渲染效果**:
```
▶ 📝 记忆总结
├────────────────────
│ 场所：
│ - 卧室：双人床在门口...
│ 
│ 规则：
│ - 全局：不许在对方...
│ 
│ 称呼：
│ - 用户称呼AI：小美...
└────────────────────
```

---

### Summary 标签（场景总结）

**用途**: 详细的场景状态信息

**示例**:
```xml
<summary>
场景：公园的长椅上；
服饰状态细节：白色连衣裙、粉色内衣、白色平底鞋；
姿态动作：坐在长椅上，双手放在膝盖上；
事件信息提炼：公园→散步→坐下休息→聊天；
发情程度：15
心动程度：25
</summary>
```

**渲染效果**:
```
▶ 📊 场景信息
├──────────────────────────
│ 场景：  公园的长椅上
│ 服饰：  白色连衣裙、粉色内衣...
│ 动作：  坐在长椅上，双手放在...
│ 事件：  公园→散步→坐下休息...
│ 发情度：15 ❤️
│ 心动度：25 ✨
└──────────────────────────
```

---

## 🔄 对话历史记录工作流程

### 1. 用户发送消息

```
用户: "你今天看起来很开心"
```

系统自动附加 UserPrompt（不显示）

### 2. AI 生成回复

AI 会参考：
- ✅ 系统提示词（包含角色设定）
- ✅ 记录区（上一次的心动度和发情度）
- ✅ 记忆精炼区（场所、规则、称呼）
- ✅ 回顾区（历史场景状态）
- ✅ 最近10条对话历史

### 3. 解析 AI 回复

系统自动提取：
- 📝 mem 标签内容 → 更新记忆精炼区
- 📊 summary 标签内容 → 更新回顾区
- 💖 心动程度数值 → 更新记录区
- ❤️ 发情程度数值 → 更新记录区

### 4. 下一轮对话

新的系统提示词会包含更新后的所有记录，确保 AI 保持上下文连贯。

---

## 🎯 最佳实践

### 1. 充分利用场景信息

悬停查看详细信息可以：
- 了解当前场景细节
- 追踪角色情感变化
- 理解 AI 的行为动机

### 2. 注意情感数值变化

观察心动度和发情度的变化趋势：
- 数值上升：说明互动效果良好
- 数值下降：可能需要调整对话方式
- 数值稳定：角色状态平稳

### 3. 使用多轮对话

多轮对话可以：
- 建立更深的角色关系
- 积累更多的记忆信息
- 观察情感的自然变化

### 4. 设定规则和称呼

明确的规则和称呼可以：
- 让 AI 更好地理解你的期望
- 保持角色扮演的一致性
- 创建更沉浸的对话体验

---

## 🐛 常见问题

### Q: 为什么场景信息图标不显示？

**A**: 场景信息图标只在 `<feature>` 标签后显示。确保 AI 回复中包含了 feature 标签和 summary 标签。

### Q: 心动度和发情度没有更新？

**A**: 检查 AI 回复的 `<summary>` 标签中是否包含了这两个数值。格式应为：
```
心动程度：25
发情程度：15
```

**注意**: 用户提示词已经强化，会自动提醒 AI 必须包含这两个数值。如果仍然缺失，可能是 AI 理解问题，建议重新发送消息。

### Q: 移动端看不到场景信息？

**A**: 移动端使用不同的展示方式：
- 不再使用悬停提示（Tooltip）
- 点击"查看场景详情"按钮
- 会从底部弹出抽屉（Sheet）
- 显示所有场景信息

### Q: 记忆总结没有保存？

**A**: 确保 AI 回复中包含了 `<mem>` 标签。如果标签格式不正确，解析可能会失败。

### Q: 多个 speech 标签时间戳显示多次？

**A**: 这是一个已修复的问题。现在时间戳只会在最后一个 speech 后显示一次。

---

## 📞 技术支持

如遇到其他问题，请：
1. 检查控制台错误信息
2. 查看 README.md 和技术文档
3. 提交 Issue 反馈

---

**文档版本**: v1.0  
**最后更新**: 2024年12月31日

